
# MedSphere - Comprehensive Application Documentation

## 1. Introduction

This document provides a comprehensive and detailed overview of the MedSphere application's architecture, components, data structures, and logic. It is intended to be a living document, updated with every change, to serve as a single source of truth for understanding the application's inner workings. This knowledge base will be used by the AI Study Buddy to provide expert assistance to users.

---

## 2. Core Technologies

The application is built on a modern, robust, and scalable tech stack:

-   **Frontend Framework**: Next.js (with App Router)
-   **UI Library**: React & TypeScript
-   **Styling**: Tailwind CSS with ShadCN UI components
-   **State Management**: Zustand
-   **Backend Services**:
    -   **Database**: Firebase Firestore
    -   **Authentication**: Firebase Authentication
    -   **File Storage & Delivery**: Cloudinary
-   **Generative AI**: Google's Genkit
-   **Icons**: Lucide React
-   **Animations**: Framer Motion

---

## 3. Project Structure Overview

The project is organized into several key directories within the `src` folder:

-   **/app**: Contains all pages and layouts, following the Next.js App Router structure.
    -   **/(main)**: The main layout for the authenticated user experience, including the sidebar and header.
    -   **/(auth)**: (If present) Would contain authentication-related pages like login/signup.
    -   **/api**: Houses all server-side API routes.
-   **/components**: Reusable React components used throughout the application.
    -   **/ui**: Core, unstyled UI primitives from ShadCN.
    -   **/profile**: Components specific to the user profile page.
    -   **Other files**: Standalone components like `Sidebar`, `Header`, `FileCard`, etc.
-   **/ai**: All Generative AI-related code.
    -   **/flows**: Genkit flows that define the core AI logic (e.g., chatting, question generation).
    -   **/prompts**: Stores the detailed text prompts fed to the AI models.
-   **/firebase**: Configuration and hooks for Firebase integration.
-   **/hooks**: Custom React hooks for shared client-side logic.
-   **/lib**: Core application logic, services, and utility functions.
-   **/stores**: Zustand state management stores.
-   **/docs**: Documentation files, including `backend.json` and this document.

---

## 4. Data Models (from `docs/backend.json`)

The application revolves around a few core data entities stored in Firestore.

### 4.1. `Content` Entity
Represents any piece of content in the application's hierarchy.

-   **`id`**: Unique identifier.
-   **`name`**: Display name (e.g., "Level 1", "Anatomy", "Lecture 1.pdf").
-   **`type`**: The type of content. Can be:
    -   `LEVEL`: Top-level academic year (e.g., "Level 1").
    -   `SEMESTER`: A semester within a level (e.g., "Semester 1").
    -   `SUBJECT`: A subject within a semester.
    -   `FOLDER`: A user-created folder.
    -   `FILE`: An uploaded file.
    -   `LINK`: A saved URL.
    -   `INTERACTIVE_QUIZ`, `INTERACTIVE_EXAM`, `INTERACTIVE_FLASHCARD`: AI-generated interactive content.
-   **`parentId`**: The `id` of the parent item, establishing the hierarchy. `null` for top-level `LEVEL` items.
-   **`order`**: A number used to sort items within the same parent.
-   **`metadata`**: An object containing type-specific data:
    -   `storagePath`: The Cloudinary URL where the file is stored.
    -   `cloudinaryPublicId`: The ID used to manage the asset in Cloudinary.
    -   `mime`: The file's MIME type (e.g., `application/pdf`).
    -   `iconURL`: URL for a custom folder/subject icon.
    -   `quizData`: JSON string for interactive content.
    -   `isClassContainer`: Boolean, true if a folder represents a class.
    -   `isHidden`: Boolean, if true, content is only visible to admins.

### 4.2. `UserProfile` Entity
Stores all information related to a user.

-   **`id` / `uid`**: Unique user identifier, linked to Firebase Auth.
-   **`studentId`**: The user's verified university student ID.
-   **`displayName`**: The user's full name.
-   **`username`**: The user's chosen unique username.
-   **`email`**, **`photoURL`**: Basic profile info.
-   **`roles`**: An array defining user permissions. Each role has a `scope` (`global` or a specific item `id`) and a list of `permissions` (e.g., `canDelete`, `canAccessAdminPanel`).
-   **`isBlocked`**: If true, the user cannot access the application.
-   **`favorites`**: An array of `Content` item IDs that the user has favorited.
-   **`sessions`**: Tracks active user sessions on different devices.
-   **`stats`**: Tracks user activity for achievements (e.g., `filesUploaded`).
-   **`achievements`**: A list of badges the user has earned.

### 4.3. Other Entities
-   **`QuestionSet`**: Stores questions generated by the AI from a source file, linked to a user.
-   **`ClaimedStudentId`**: Ensures a student ID is linked to only one account.
-   **`AuditLog`**: Records all administrative actions performed by admins.

---

## 5. Pages and UI Components

### 5.1. Main Layout (`/app/(main)/layout.tsx`)
This is the primary wrapper for the authenticated app experience. It includes:
-   **`Sidebar`**: The main navigation tree. Collapsible on desktop and an off-canvas sheet on mobile.
-   **`Header`**: The top bar containing the logo, a global search input, and navigation buttons (e.g., to Admin Panel, Questions Creator, Profile).
-   **`Breadcrumbs`**: A navigation aid showing the user's current location in the content hierarchy.

### 5.2. Home Page (`/app/(main)/page.tsx`)
-   **Purpose**: The main dashboard and entry point.
-   **Content**: Displays the top-level "Levels" for navigation. If no content exists, it automatically seeds the initial academic structure.

### 5.3. Folder/Level Pages (`/app/(main)/folder/[id]`, `/app/(main)/level/[name]`)
-   **Purpose**: To display the contents of a folder, subject, semester, or level.
-   **`FileExplorerHeader`**: Shows the current folder's name and icon, and provides navigation controls and the "Add Content" menu.
-   **`FolderGrid`**: The main component that renders the list of items.
    -   **`SubjectCard`**: A grid-style card for `SUBJECT` type content.
    -   **`FolderCard`**: A card for `FOLDER` or `SEMESTER` types. Can be grid or list style.
    -   **`FileCard`**: A list-item style card for `FILE`, `LINK`, and interactive content.
-   **`AddContentMenu`**: A popover menu that allows users with permissions to create new folders, upload files, add links, or create flashcards.

### 5.4. Profile Page (`/app/(main)/profile/page.tsx`)
-   **Purpose**: Displays and allows editing of the user's profile.
-   **Key Components**:
    -   **Cover Photo & Avatar**: Editable images.
    -   **`AiStudyBuddy`**: An interactive AI assistant providing personalized insights and answering questions. Its appearance and greeting change based on the time of day.
    -   **`InfoCard`**: Displays user details like Student ID, email, and academic level.
    -   **`ActiveSessions`**: Shows a list of devices the user is logged into and allows logging out other sessions.
    -   **`FavoritesSection`**: Displays a list of the user's favorited content for quick access.
    -   **`AchievementsSection`**: Shows earned and in-progress achievement badges.

### 5.5. Admin Panel (`/app/(main)/admin/page.tsx`)
-   **Purpose**: A centralized dashboard for user and content management, accessible only to admins.
-   **Features**:
    -   **Tabs**: "All Users", "Admins", "Management", "History".
    -   **User List**: Displays all users with search, sort, and filter functionality.
    -   **Actions**: Admins can promote/demote other admins, block/unblock users, and delete users.
    -   **`PermissionsDialog`**: A detailed dialog for setting granular permissions for sub-admins, scoped globally or to specific content items.
    -   **`AuditLog`**: The "History" tab shows a log of all administrative actions.

### 5.6. Questions Creator (`/app/(main)/questions-creator/...`)
-   **Purpose**: A dedicated interface for generating questions, exams, and flashcards from PDF documents using AI.
-   **Tabs**:
    -   **Generate**: The main screen where a user can upload a file or select one from their library to start the generation process.
    -   **Prompts**: Allows admins to view and edit the AI prompts used for generation.
    -   **Saved Questions**: Displays a list of all previously generated and saved question sets.
-   **Output**: The generated content is displayed as raw text and structured JSON, which can then be saved as interactive content items.

### 5.7. File Preview Modal (`/components/FilePreviewModal.tsx`)
-   **Purpose**: A full-screen or large modal for viewing file content.
-   **Supported Formats**: PDF, images, videos, audio, Markdown, and plain text.
-   **`ChatPanel`**: An integrated AI chat interface that can be opened alongside the file. It allows users to ask questions about the document's content.

---

## 6. AI & Business Logic

### 6.1. AI Flows (`/src/ai/flows/`)
-   **`study-buddy-flow.ts` / `study-buddy-chat-flow.ts`**: Powers the profile page assistant. It receives user stats and chat history to provide personalized, time-aware greetings, insights, and answers.
-   **`question-gen-flow.ts`**: Handles the multi-step process of generating educational content from a document. It first generates raw text questions, then converts that text into a structured JSON format.
-   **`chat-flow.ts`**: The core logic for the "Ask AI" feature in the file preview. It takes document content, chat history, and a user's question to provide a context-aware answer.
-   **`search-flow.ts`**: Implements a client-side fuzzy search using `Fuse.js` to quickly find files and folders.

### 6.2. Core Services (`/src/lib/`)
-   **`contentService.ts`**: A crucial service that encapsulates all business logic for interacting with `Content` items in Firestore. It handles creating, renaming, moving, copying, deleting, and updating content, as well as file uploads to Cloudinary and managing permissions.
-   **`authService.ts`**: Manages user verification against a predefined list of student IDs and handles the initial creation of user profiles in Firestore.
-   **`auth-store.ts`**: The central Zustand store for managing the application's authentication state. It holds the current user's profile, determines permissions (`can` function), and manages the content hierarchy for permission checking.
